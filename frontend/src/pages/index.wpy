<template>
  <view class="container">
    <button @tap="sendData">开门</button>
    <repeat wx:for="{{messageList}}" wx:key="index" index="index" item="item">
      <text>{{item}}</text>
    </repeat>
  </view>
</template>

<script>
import wepy from 'wepy';

export default class Index extends wepy.page {
  config = {
    navigationBarTitleText: 'index'
  };

  data = {
    messageList: []
  };

  methods = {
    sendData: () => {
      wx.sendSocketMessage({
        data: JSON.stringify({
          actionType: 'openTheDoor'
        })
      });
    }
  };

  onLoad = () => {
    wx.connectSocket({
      url: 'wss://project.yyccyy.com/smart-home/backend/api/webSocket',
      success: () => {
        // 连接成功
        wx.onSocketOpen(() => {
          wx.sendSocketMessage({
            data: JSON.stringify({
              type: 'test'
            })
          });
        });

        // 接收数据
        wx.onSocketMessage(({ data }) => {
          console.log(`webSocket server receiver data: ${data}`);
          this.messageList.push(data);
          this.$apply();
        });
      },
      fail: (e) => {
        console.error(e);
      }
    });
  };
}
</script>

<style lang="less">

</style>
